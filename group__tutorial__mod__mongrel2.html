<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta name="keywords" content="frozen, data, processing, big data, daemon, fast, flexible"/>
<title>Frozen - flexible data processing daemon</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="stylesheet.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">frozen
   &#160;<span id="projectnumber">1.0</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">Tutorial: mongrel2 handlers</div>  </div>
<div class="ingroups"><a class="el" href="group__tutorial.html">Tutorials</a></div></div>
<div class="contents">
<h2><a class="anchor" id="tutorial_mod_overview"></a>
Overview</h2>
<p>With frozen you can easily create custom handlers for mongrel2. To make one we need <a class="el" href="group__zeromq__t.html">zeromq_t</a> and <a class="el" href="group__mod__machine__mongrel2.html">module/c_mongrel2</a>. Mongrel create two ZeroMQ sockets, one for pushing client's request to handler and one for getting reply from handler. So, we too need create two sockets. Request will flow from one socket, pass through set of machines and end up in second socket.</p>
<h2><a class="anchor" id="tutorial_mod_example"></a>
Example configuration</h2>
<div class="fragment"><pre class="fragment">{ <span class="keyword">class </span>=&gt; &quot;daemon/thread&quot;, loop = (uint_t)<span class="charliteral">&#39;1&#39;</span> },
{ <span class="keyword">class </span>=&gt; &quot;emitter&quot;, request = {
        request = {
                action      = (action_t)<span class="stringliteral">&quot;transfer&quot;</span>,
                destination = (<a class="code" href="structmachine__t.html" title="Machine structure.">machine_t</a>){
                        { <span class="keyword">class </span>= &quot;modules/c_mongrel2_parse&quot; },                         <span class="comment">// parse mongrel2 protocol</span>
                        
                        { <span class="keyword">class </span>= &quot;switch&quot;, rules = {                                   <span class="comment">// drop disconnect requests</span>
                                {
                                        request = { headers = <span class="stringliteral">&quot;{\&quot;METHOD\&quot;:\&quot;JSON\&quot;}&quot;</span> },
                                        machine = (<a class="code" href="structmachine__t.html" title="Machine structure.">machine_t</a>){
                                                { <span class="keyword">class </span>= &quot;end&quot; }
                                        }
                                }
                        }},
                        
                        { <span class="keyword">class </span>= &quot;assign&quot;, before = {                                  <span class="comment">// assign simple reply</span>
                                body = <span class="stringliteral">&quot;HTTP/1.1 200 OK\r\nContent-Length: 6\r\n\r\nhello!&quot;</span>
                        }},
                        
                        { <span class="keyword">class </span>= &quot;modules/c_mongrel2_reply&quot; },                         <span class="comment">// pack our reply according mongrel2 protocol</span>
                        { <span class="keyword">class </span>= &quot;convert&quot;, items = {                                  <span class="comment">// convert buffer to raw_t, because zeromq data do not work with structures</span>
                                buffer = { type = (datatype_t)<span class="stringliteral">&quot;raw_t&quot;</span> }
                        }},
                        
                        { <span class="keyword">class </span>= &quot;data/query&quot;,
                                data = (<a class="code" href="structzeromq__t.html">zeromq_t</a>){
                                        type     = <span class="stringliteral">&quot;pub&quot;</span>,
                                        connect  = <span class="stringliteral">&quot;tcp://127.0.0.1:9998&quot;</span>
                                }
                        },
                        { <span class="keyword">class </span>= &quot;end&quot; }
                }
        },
        machine = (<a class="code" href="structmachine__t.html" title="Machine structure.">machine_t</a>){
                { <span class="keyword">class </span>= &quot;data/query&quot;,
                        data = (<a class="code" href="structzeromq__t.html">zeromq_t</a>){
                                type     = <span class="stringliteral">&quot;pull&quot;</span>,
                                identity = <span class="stringliteral">&quot;82209006-86FF-4982-B5EA-D1E29E55D481&quot;</span>,
                                connect  = <span class="stringliteral">&quot;tcp://127.0.0.1:9999&quot;</span>
                        }
                }
        }
}},
{ <span class="keyword">class </span>= &quot;end&quot; }
</pre></div><p>Here we have single-threaded handler which only send simple "hello!" string back to client.</p>
<h2><a class="anchor" id="tutorial_mod_bench_data"></a>
Benchmarking data</h2>
<p>To benchmark this we use "ab" from apache-tools, 100000 requests in 30 concurrent threads. First benchmark for mongrel2+frozen set: </p>
<div class="fragment"><pre class="fragment"><span class="preprocessor"># ab -n 100000 -c 30 http://127.0.0.1:6767/</span>
<span class="preprocessor"></span>This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;
Copyright 1996 Adam Twiss, Zeus Technology Ltd, http:<span class="comment">//www.zeustech.net/</span>
Licensed to The Apache Software Foundation, http:<span class="comment">//www.apache.org/</span>

Benchmarking 127.0.0.1 (be patient)
Completed 10000 requests
Completed 20000 requests
Completed 30000 requests
Completed 40000 requests
Completed 50000 requests
Completed 60000 requests
Completed 70000 requests
Completed 80000 requests
Completed 90000 requests
Completed 100000 requests
Finished 100000 requests


Server Software:        
Server Hostname:        127.0.0.1
Server Port:            6767

Document Path:          /
Document Length:        6 bytes

Concurrency Level:      30
Time taken <span class="keywordflow">for</span> tests:   10.848 seconds
Complete requests:      100000
Failed requests:        17355
   (Connect: 0, Receive: 0, Length: 17355, Exceptions: 0)
Write errors:           0
Total transferred:      3636380 bytes
HTML transferred:       495870 bytes
Requests per second:    9217.89 [#/sec] (mean)
Time per request:       3.255 [ms] (mean)
Time per request:       0.108 [ms] (mean, across all concurrent requests)
Transfer rate:          327.34 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0    1   0.4      1       5
Processing:     0    3   0.9      2       7
Waiting:        0    2   1.2      2       7
Total:          0    3   0.8      3       9
WARNING: The median and mean <span class="keywordflow">for</span> the processing time are not within a normal deviation
        These results are probably not that reliable.

Percentage of the requests served within a certain time (ms)
  50%      3
  66%      4
  75%      4
  80%      4
  90%      4
  95%      5
  98%      5
  99%      6
 100%      9 (longest request)
</pre></div><p>Second benchmark is mongrel2 c library (<a href="https://github.com/derdewey/mongrel2_c_handler">https://github.com/derdewey/mongrel2_c_handler</a>) and it's body_to_upper handler. </p>
<div class="fragment"><pre class="fragment"><span class="preprocessor"># ab -n 100000 -c 30 http://127.0.0.1:6767/</span>
<span class="preprocessor"></span>This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;
Copyright 1996 Adam Twiss, Zeus Technology Ltd, http:<span class="comment">//www.zeustech.net/</span>
Licensed to The Apache Software Foundation, http:<span class="comment">//www.apache.org/</span>

Benchmarking 127.0.0.1 (be patient)
Completed 10000 requests
Completed 20000 requests
Completed 30000 requests
Completed 40000 requests
Completed 50000 requests
Completed 60000 requests
Completed 70000 requests
Completed 80000 requests
Completed 90000 requests
Completed 100000 requests
Finished 100000 requests


Server Software:        Mongrel2/1.7.5
Server Hostname:        127.0.0.1
Server Port:            6767

Document Path:          /
Document Length:        242 bytes

Concurrency Level:      30
Time taken <span class="keywordflow">for</span> tests:   7.566 seconds
Complete requests:      100000
Failed requests:        0
Write errors:           0
Total transferred:      43302165 bytes
HTML transferred:       24201210 bytes
Requests per second:    13217.79 [#/sec] (mean)
Time per request:       2.270 [ms] (mean)
Time per request:       0.076 [ms] (mean, across all concurrent requests)
Transfer rate:          5589.44 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0    1   0.3      1       7
Processing:     0    1   0.4      1       7
Waiting:        0    1   0.3      1       7
Total:          1    2   0.5      2       9

Percentage of the requests served within a certain time (ms)
  50%      2
  66%      3
  75%      3
  80%      3
  90%      3
  95%      3
  98%      3
  99%      3
 100%      9 (longest request)
</pre></div><p>Last benchmark is plain nginx setup on same computer, just for reference: </p>
<div class="fragment"><pre class="fragment"><span class="preprocessor"># ab -n 100000 -c 30 http://127.0.0.1/</span>
<span class="preprocessor"></span>This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;
Copyright 1996 Adam Twiss, Zeus Technology Ltd, http:<span class="comment">//www.zeustech.net/</span>
Licensed to The Apache Software Foundation, http:<span class="comment">//www.apache.org/</span>

Benchmarking 127.0.0.1 (be patient)
Completed 10000 requests
Completed 20000 requests
Completed 30000 requests
Completed 40000 requests
Completed 50000 requests
Completed 60000 requests
Completed 70000 requests
Completed 80000 requests
Completed 90000 requests
Completed 100000 requests
Finished 100000 requests


Server Software:        nginx/1.0.4
Server Hostname:        127.0.0.1
Server Port:            80

Document Path:          /
Document Length:        6 bytes

Concurrency Level:      30
Time taken <span class="keywordflow">for</span> tests:   5.587 seconds
Complete requests:      100000
Failed requests:        0
Write errors:           0
Total transferred:      21401498 bytes
HTML transferred:       600042 bytes
Requests per second:    17899.24 [#/sec] (mean)
Time per request:       1.676 [ms] (mean)
Time per request:       0.056 [ms] (mean, across all concurrent requests)
Transfer rate:          3740.92 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0    1   0.1      1       2
Processing:     0    1   0.2      1       5
Waiting:        0    1   0.2      1       4
Total:          1    2   0.3      2       6

Percentage of the requests served within a certain time (ms)
  50%      2
  66%      2
  75%      2
  80%      2
  90%      2
  95%      2
  98%      2
  99%      3
 100%      6 (longest request)
</pre></div><h2><a class="anchor" id="tutorial_mod_bench_res"></a>
Benchmarking results</h2>
<p>Mongrel C library goes little faster than frozen (even with all that json parsing and stuff), and nginx is way faster both of them. To be fair, don't forget that frozen have only one thread to handle requests. Frozen would be improved for speed and multi-threading. </p>
</div>


<hr class="footer"/><address class="footer"><small>
Generated on Thu Feb 2 2012 16:35:47 for frozen by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.5.1</small></address>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-7806052-2']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body>
</html>
