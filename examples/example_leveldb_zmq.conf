{ class = "thread" },

{ class = "emitter", request = {
	request = {
		action = (action_t)"write",
		key    = (raw_t)"testkey",
		value  = (raw_t)"testvalue\n"
	},
	machine = (machine_t){
		{ class = "shop/pass", shop = (machine_t)"leveldb" },
		{ class = "end" }
	}
}},

{ class = "emitter", request = {
	request = {
		action = (action_t)"read",
		key    = (raw_t)"testkey",
		value  = (raw_t)"1"
	},
	machine = (machine_t){
		{ class = "shop/pass", shop = (machine_t)"leveldb" },
		{ class = "data/query", data = (fd_t)"stdout", request = {
			action = (action_t)"write",
			buffer = (env_t)"value"
		}},
		{ class = "end" }
	}
}},

/*
{ class = "emitter", request = {
	request = {
		action = (action_t)"enum",
		buffer = (raw_t){},
		myenum = (machine_t){
			{ class = "shop/pass", shop = (machine_t)"leveldb" },
			{ class = "end" }
		}
	},
	machine = (machine_t){
		{ class = "modules/mustache", template = "Items list:\n{{#myenum}} - {{data}}\n{{/myenum}}", output = (hashkey_t)"buffer" },
		{ class = "data/query", data = (fd_t)"stdout", request = {
			action = (action_t)"write",
			buffer = (env_t)"buffer"
		}},
		{ class = "end" }
	}
}},*/
{ class = "kill" },
NULL,

// client
{ class = "null", name  = "leveldb" },
{ class = "try", shop = (machine_t){
	{ class = "assign", before = { return_to = (void_t)"" } },
	{ class = "implode" },
	
	{ class = "assign", before = { packed = (raw_t)"" }},
	{ class = "query", data = (env_t)"buffer", request = {
		action      = (action_t)"convert_to",
		destination = (env_t)"packed",
		format      = (format_t)"binary"
	}},
	
	{
		class   = "data/query",
		data    = (named_t){
			name = "leveldb_req",
			data = (zeromq_t){
				type = "req",
				connect = "tcp://127.0.0.1:8888"
			}
		},
		request = {
			action = (action_t)"write",
			buffer = (env_t)"packed"
		}
	},
	{
		class   = "data/query",
		data    = (named_t)"leveldb_req",
		request = {
			action      = (action_t)"transfer",
			destination = (env_t)"packed"
		}
	},
	
	{ class = "query", data = (env_t)"buffer", request = {
		action      = (action_t)"convert_from",
		source      = (env_t)"packed",
		format      = (format_t)"binary"
	}},
	{ class = "shop/return" }
}},
{ class = "shop/return" },
{ class = "end" },
NULL,

// server
{ class = "thread", loop = (uint_t)"1" },
{ class = "query",
	data = (named_t){
		name = "leveldb_rep",
		data = (zeromq_t){
			type = "rep",
			bind = "tcp://127.0.0.1:8888"
		}
	},
	request = {
		action = (action_t)"transfer",
		destination = (machine_t){
			{ class = "assign", before = { request = (hash_t){} }},
			{ class = "query", data = (env_t)"request", request = {
				action      = (action_t)"convert_from",
				source      = (env_t)"buffer",
				format      = (format_t)"binary"
			}},
			{ class = "explode", buffer = (hashkey_t)"request" },
			
			{
				class = "modules/leveldb",
				path  = "test_leveldb/"
			},
			
			{ class = "implode", buffer = (hashkey_t)"request" },
			
			{ class = "assign", before = { buffer = (raw_t)"" }},
			{ class = "query", data = (env_t)"request", request = {
				action      = (action_t)"convert_to",
				destination = (env_t)"buffer",
				format      = (format_t)"binary"
			}},
			
			{ class = "query", data = (named_t)"leveldb_rep", request = {
				action  = (action_t)"write",
				buffer  = (env_t)"buffer"
			}},
			{ class = "end" }
		}
	}
},
{ class = "end" }
